1) Для начала получим список всех хостов в DMZ. Наличие Linux на борту будем определять по открытому 22му порту. 

nmap 10.240.240.0/24 -p 22 --open | grep 10.240.240. | awk '{print $NF}' | sed 's/(//' | sed 's/)//'

Монструозная конструкция с двумя sed объясняется просто - автор не умеет в регулярки и потому вычленяет разные символы разными операторами.

2) Скармливаем этот список Ansible и проверяем его актуальность.


Создаём файл host.

[dmz_host]

[dmz_host:vars]
ansible_connection=ssh
ansible_ssh_user=user

Под грифом dmz_host мы записываем полученные ранее хосты.  В поля ansible_ssh_user  вводим имя пользователя для доступа SSH к хосту. 

3) Проверяем актуальность нашего списка. 

ansible all -m shell -a "whoami" -i ./host2 -b -k | grep CHANGED -A 1 

Вывод отфильтрует нам хосты, откликнувшиеся на команду "whoami". 

4)   






















